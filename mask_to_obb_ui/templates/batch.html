<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Batch OBB Processor</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height:100vh; padding:20px; }
    .container { max-width: 95vw; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
    .header h2 { font-size: 2em; margin-bottom:8px; }
    .header p { font-size:1.05em; opacity:0.9; }
    .tabs { margin-top: 12px; display:flex; gap:10px; justify-content:center; }
    .tab { text-decoration:none; padding:8px 14px; border-radius:8px; border:1px solid rgba(255,255,255,0.4); color:#fff; background: rgba(255,255,255,0.15); }
    .tab.active { background:#fff; color:#667eea; border-color:#fff; font-weight:600; }
    .content { padding:40px; }
    .panel { background:white; border:1px solid #ddd; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .upload { background:#f8f9fa; border-radius:10px; padding:30px; margin-bottom:30px; text-align:center; }
    .upload input[type=file] { display:none; }
    .upload .box { background:white; border:2px dashed #ddd; border-radius:10px; padding:30px; cursor:pointer; transition:all .3s ease; }
    .upload .box:hover { border-color:#667eea; background:#f0f4ff; }
    .upload .box i { font-size:2em; color:#667eea; margin-bottom:10px; }
    .upload .box label { display:block; font-weight:bold; color:#333; margin-bottom:5px; }
    .upload .box p { color:#666; font-size:.9em; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:12px 18px; border-radius:25px; border:none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; cursor:pointer; }
    .btn:hover { filter: brightness(1.05); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:30px; }
    .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; }
    .card { background:white; border:1px solid #ddd; border-radius:10px; padding:20px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
    .card h4 { color:#333; margin-bottom:10px; font-size:1.1em; }
    .value { font-size:2em; color:#667eea; font-weight:bold; }
    .charts { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .download { display:flex; justify-content:center; margin-top: 16px; }
    .download a { text-decoration:none; padding:10px 14px; border-radius:8px; background:#f0f4ff; border:1px solid #dde3ff; color:#445; }
    .download a:hover { background:#e6ecff; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#f8f9fa; }
    .examples { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; margin-top:20px; }
    .example { background:white; border:1px solid #ddd; border-radius:10px; padding:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); text-align:center; }
    .example h4 { margin-bottom:8px; }
    .example img { width:100%; height:auto; border-radius:8px; }
    .loading { display:none; text-align:center; padding:30px; }
    .loading.show { display:block; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2><i class="fas fa-layer-group"></i> Batch OBB Processor</h2>
      <p>ZIP dataset yükleyin, yeni OBB'leri üretin ve gelişimi analiz edin</p>
      <div class="tabs">
        <a class="tab" href="/">Dönüşüm</a>
        <a class="tab" href="/viewer">Viewer</a>
        <a class="tab active" href="/batch">Batch</a>
      </div>
    </div>

    <div class="content">
      <div class="panel upload">
        <form id="batchForm" enctype="multipart/form-data">
          <div class="box" onclick="document.getElementById('datasetZip').click()">
            <input type="file" id="datasetZip" name="dataset_zip" accept=".zip" required aria-label="Dataset ZIP">
            <i class="fas fa-file-zipper"></i>
            <label for="datasetZip">Dataset ZIP</label>
            <p>Mask JSON'lar + YOLO label TXT'ler + görseller bir ZIP içinde</p>
          </div>
          <div style="margin-top:16px; display:flex; gap:10px; justify-content:center; align-items:center;">
            <button type="submit" class="btn" id="batchSubmit"><i class="fas fa-play"></i> İşle</button>
            <div class="loading" id="batchLoading">
              <div class="spinner"></div>
              <div style="color:#667eea; font-weight:600;">Dataset işleniyor...</div>
            </div>
          </div>
        </form>
      </div>

      <div id="batchResults" style="display:none;">
        <div class="stats">
          <div class="card"><h4>Mean IoU (Old → New)</h4><div class="value" id="meanPair">-</div></div>
          <div class="card"><h4>Mean İyileşme</h4><div class="value" id="meanImp">-</div></div>
          <div class="card"><h4>İyileşen / Kötüleşen / Aynı</h4><div class="value" id="counts">-</div></div>
          <div class="card"><h4>İşlenen Görsel</h4><div class="value" id="imgCount">-</div></div>
        </div>
        <div class="charts" style="margin-top:20px;">
          <div class="panel">
            <h3>IoU Dağılımları</h3>
            <img id="chart1" style="width:100%; height:auto;" />
          </div>
          <div class="panel">
            <h3>İyileşme Dağılımı</h3>
            <img id="chart2" style="width:100%; height:auto;" />
          </div>
        </div>
        <div class="panel" style="margin-top:20px;">
          <h3>Görsel Bazlı Özet (ilk 100)</h3>
          <table>
            <thead><tr><th>Görsel</th><th>Mean Old</th><th>Mean New</th><th>Adet</th></tr></thead>
            <tbody id="perImage"></tbody>
          </table>
        </div>
        <div class="panel" style="margin-top:20px;">
          <h3>Örnek Görselleştirmeler</h3>
          <div class="examples" id="examples"></div>
        </div>
        <div class="download">
          <a id="downloadZip" href="#" download><i class="fas fa-download"></i> Yeni Dataset (ZIP) İndir</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('batchForm');
    const results = document.getElementById('batchResults');
    const meanPair = document.getElementById('meanPair');
    const meanImp = document.getElementById('meanImp');
    const counts = document.getElementById('counts');
    const imgCount = document.getElementById('imgCount');
    const chart1 = document.getElementById('chart1');
    const chart2 = document.getElementById('chart2');
    const perImage = document.getElementById('perImage');
    const dl = document.getElementById('downloadZip');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      // loading on
      document.getElementById('batchLoading').classList.add('show');
      document.getElementById('batchSubmit').disabled = true;
      const resp = await fetch('/batch_process', { method: 'POST', body: fd });
      const data = await resp.json();
      // loading off
      document.getElementById('batchLoading').classList.remove('show');
      document.getElementById('batchSubmit').disabled = false;
      if (!data.success) { alert(data.error || 'Hata'); return; }
      const s = data.summary;
      meanPair.textContent = `${s.mean_old.toFixed(3)} → ${s.mean_new.toFixed(3)}`;
      meanImp.textContent = `${s.mean_improvement.toFixed(3)}`;
      counts.textContent = `${s.improved} / ${s.degraded} / ${s.unchanged}`;
      imgCount.textContent = `${s.images_processed}`;
      if (data.charts) {
        if (data.charts.iou_distribution) chart1.src = data.charts.iou_distribution;
        if (data.charts.improvement_distribution) chart2.src = data.charts.improvement_distribution;
      }
      perImage.innerHTML = (data.per_image || []).map(r => `<tr><td>${r.image}</td><td>${r.mean_old.toFixed(3)}</td><td>${r.mean_new.toFixed(3)}</td><td>${r.count}</td></tr>`).join('');
      dl.href = data.download_url;
      // examples
      const ex = document.getElementById('examples');
      const parts = [];
      if (data.examples && data.examples.improved) {
        data.examples.improved.forEach((e, i) => {
          parts.push(`<div class="example"><h4>İyileşen ${i+1}</h4><div style="margin-bottom:6px; color:#333;">${e.image}</div><img src="${e.src}"/><div style="margin-top:6px; color:#667eea; font-weight:600;">Mean IoU: ${e.mean_old.toFixed(3)} → ${e.mean_new.toFixed(3)} (Δ ${e.imp.toFixed(3)})</div></div>`);
        });
      }
      if (data.examples && data.examples.degraded && data.examples.degraded.length > 0) {
        data.examples.degraded.forEach((e, i) => {
          parts.push(`<div class="example"><h4>Kötüleşen ${i+1}</h4><div style="margin-bottom:6px; color:#333;">${e.image}</div><img src="${e.src}"/><div style="margin-top:6px; color:#dc3545; font-weight:600;">Mean IoU: ${e.mean_old.toFixed(3)} → ${e.mean_new.toFixed(3)} (Δ ${e.imp.toFixed(3)})</div></div>`);
        });
      }
      ex.innerHTML = parts.join('');
      results.style.display = 'block';
    });
  </script>
</body>
</html>


